.onLoad <- function(lib, pkg){
  pkgdir <- file.path(lib, pkg)
  sysdir <- rappdirs::user_data_dir('tesseract')
  pkgdata <- file.path(pkgdir, "tessdata")
  sysdata <- file.path(sysdir, "tessdata")
  if(file.exists(pkgdata) && !file.exists(file.path(sysdata, "eng.traineddata"))){
    message("First use of Tesseract: copying language data")
    olddir <- getwd()
    on.exit(setwd(olddir))
    setwd(pkgdir)
    dir.create(sysdir, showWarnings = FALSE, recursive = TRUE)
    file.copy("tessdata", sysdir, recursive = TRUE)
  }
  if(is.na(Sys.getenv("TESSDATA_PREFIX", NA))){
    if(file.exists(file.path(sysdata, "eng.traineddata"))){
      Sys.setenv(TESSDATA_PREFIX = sysdata)
    } else if(file.exists(file.path(pkgdata, "eng.traineddata"))){
      Sys.setenv(TESSDATA_PREFIX = pkgdata)
    }
  }
}

.onUnload <- function(lib){
  Sys.unsetenv("TESSDATA_PREFIX")
}

.onAttach <- function(lib, pkg){
  check_training_data()
}

check_training_data <- function(){
  tryCatch(tesseract(), error = function(e){
    warning("Unable to find English training data", call. = FALSE)
    os <- utils::sessionInfo()[[4]]
    if(grepl("ubuntu|debian", os, TRUE)){
      stop("DEBIAN / UBUNTU: Please run: apt-get install tesseract-ocr-eng")
    }
  })
}
